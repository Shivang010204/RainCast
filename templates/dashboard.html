<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainCast AI | P2P Operational Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body { 
            height: 100vh; width: 100vw; margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at top right, #1e293b, #020617);
            font-family: 'Inter', sans-serif;
            color: white;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: 240px 1fr 360px;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .main-display { display: grid; grid-template-rows: auto 1fr auto; gap: 15px; }
        .intel-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; }
        .intel-widget {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 15px; padding: 12px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .intel-widget h3 { font-size: 1.8rem; margin: 0; }
        .label-text { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: #00f3ff; opacity: 0.8; }
        #map { height: 160px; border-radius: 12px; }
        .big-temp { font-size: 5rem; font-weight: 200; margin: 0; }
        .mode-btn { 
            padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.05); 
            color: white; text-decoration: none; font-size: 0.8rem; transition: 0.3s;
            border: 1px solid transparent; cursor: pointer; display: inline-block;
        }
        .mode-btn.active { background: #00f3ff; color: #000; font-weight: 700; }
        .mode-btn:hover { border-color: #00f3ff; }
        
        #weather-status { font-weight: 700; transition: all 0.5s ease; }
        .pulse-red { color: #fb7185; text-shadow: 0 0 10px rgba(251, 113, 133, 0.4); }

        /* P2P Broadcast Notification Styling */
        #peer-toast {
            display: none; position: fixed; bottom: 30px; left: 50%; 
            transform: translateX(-50%); border: 2px solid #00f3ff; 
            z-index: 2000; width: 320px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="peer-toast" class="glass-panel">
    <span class="label-text" style="color: #00f3ff;">
        <i class="fa-solid fa-satellite-dish"></i> Incoming Peer Signal
    </span>
    <p id="peer-msg" style="font-size: 0.8rem; margin: 10px 0;">A user reported rain. Can you confirm?</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="submitReport('Rain Expected')" class="mode-btn" style="background: #10b981; color: white;">Yes, it's raining</button>
        <button onclick="closeToast()" class="mode-btn">Ignore</button>
    </div>
</div>

<div class="dashboard-container">
    <aside class="glass-panel">
        <div style="font-size: 1.2rem; font-weight: 800; color: #00f3ff; margin-bottom: 20px;">
            <i class="fa-solid fa-microchip"></i> RAINCAST_V3
        </div>
        <nav style="display: flex; flex-direction: column; gap: 8px; flex-grow: 1;">
            <span class="label-text">Operational Mode</span>
            <a href="/?user_mode=standard&city={{ weather.city if weather else '' }}" class="mode-btn {% if current_mode == 'standard' %}active{% endif %}">Standard</a>
            <a href="/?user_mode=farmer&city={{ weather.city if weather else '' }}" class="mode-btn {% if current_mode == 'farmer' %}active{% endif %}">Agricultural</a>
            <a href="/?user_mode=construction&city={{ weather.city if weather else '' }}" class="mode-btn {% if current_mode == 'construction' %}active{% endif %}">Construction</a>
        </nav>
        <a href="{{ url_for('detailed_forecast') }}" class="mode-btn" style="border: 1px solid #00f3ff; text-align: center;">14-DAY SEQUENCE</a>
    </aside>

    <main class="main-display">
        <form method="POST" class="glass-panel" style="flex-direction: row; align-items: center; padding: 10px 20px;">
            <i class="fa-solid fa-search" style="opacity: 0.5;"></i>
            <input type="text" name="city" placeholder="Scan City Name..." value="{{ weather.city if weather else '' }}" required style="background:transparent; border:none; color:white; flex:1; padding: 0 15px; outline:none; font-family: 'JetBrains Mono';">
            <div id="live-clock" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: #00f3ff;">00:00:00</div>
        </form>

        <div class="glass-panel" style="align-items: center; justify-content: center; text-align: center;">
            <p style="opacity: 0.7;">{{ weather.city if weather else 'COORD_PENDING' }}</p>
            <h1 class="big-temp">{{ weather.temp if weather else '--' }}¬∞</h1>
            <div id="weather-status" class="{{ 'pulse-red' if prediction != 'No Rain' else '' }}">
                {{ prediction if prediction else "READY" }}
            </div>
            {% if weather and weather.ai_temp %}
                <div style="font-family: 'JetBrains Mono'; font-size: 0.7rem; color: #00f3ff; margin-top: 15px;">
                    <i class="fa-solid fa-robot"></i> AI_CORRECTION: {{ weather.ai_temp }}¬∞C
                </div>
            {% endif %}
        </div>

        <div class="glass-panel" style="height: 200px;">
            <span class="label-text">Atmospheric Trend (8H)</span>
            <canvas id="weatherChart"></canvas>
        </div>
    </main>

    <aside class="main-display">
        <div class="glass-panel">
            <span class="label-text">Satellite Visual</span>
            <div id="map"></div>
        </div>

        <div class="intel-grid">
            <div class="intel-widget"><span class="label-text">Humidity</span><h3>{{ weather.hum if weather else '0' }}%</h3></div>
            <div class="intel-widget"><span class="label-text">Wind</span><h3>{{ weather.wind if weather else '0' }}</h3></div>
            <div class="intel-widget"><span class="label-text">Pressure</span><h3>1,009</h3></div>
            <div class="intel-widget"><span class="label-text">Visibility</span><h3>24 km</h3></div>
        </div>

        <div class="glass-panel" style="border: 1px solid rgba(0, 243, 255, 0.2);">
            <span class="label-text">Submit Live Report</span>
            <div style="margin-top:10px; display: grid; gap: 8px;">
                <input type="file" id="proof_img" accept="image/*" style="display:none;">
                <label for="proof_img" class="mode-btn" style="border: 1px dashed rgba(255,255,255,0.2); text-align: center;">
                    <i class="fa-solid fa-camera"></i> <span id="file-label">Attach EXIF Proof</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button type="button" onclick="submitReport('Rain Expected')" class="mode-btn" style="background: rgba(244, 63, 94, 0.2); border-color: #f43f5e;">RAIN</button>
                    <button type="button" onclick="submitReport('No Rain')" class="mode-btn" style="background: rgba(16, 185, 129, 0.2); border-color: #10b981;">CLEAR</button>
                </div>
                <p id="report-log" style="font-size: 0.65rem; color: #94a3b8; text-align: center; margin-top: 5px;"></p>
            </div>
        </div>
    </aside>
</div>
<div style="position: fixed; bottom: 5px; right: 20px; font-size: 0.6rem; color: rgba(255,255,255,0.3); font-family: 'JetBrains Mono';">
    SYSTEM_STABLE // 2026_RC_AI // <a href="{{ url_for('admin_login') }}" style="color: inherit; text-decoration: none;">STAFF_AUTH</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    function updateClock() { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }
    setInterval(updateClock, 1000); updateClock();

    {% if hourly_data %}
    const ctx = document.getElementById('weatherChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for h in hourly_data %}"{{ h.time }}",{% endfor %}],
            datasets: [{
                data: [{% for h in hourly_data %}{{ h.temp }},{% endfor %}],
                borderColor: '#00f3ff', fill: true, tension: 0.4, pointRadius: 0
            }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    {% endif %}

    {% if weather %}
    var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([{{ weather.lat }}, {{ weather.lon }}], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.circleMarker([{{ weather.lat }}, {{ weather.lon }}], { radius: 6, color: '#00f3ff', fillOpacity: 1 }).addTo(map);
    {% endif %}

    // --- P2P REPORTING & EXIF CHECK ---
    document.getElementById('proof_img').onchange = function() {
        document.getElementById('file-label').innerText = "Photo Ready";
    };

    async function submitReport(choice) {
    const fileInput = document.getElementById('proof_img'); // Check this ID matches your <input>
    const log = document.getElementById('report-log');
    
    if (fileInput.files.length === 0) {
        alert("‚ö†Ô∏è Photo Proof Required for EXIF Validation.");
        return;
    }

    log.innerText = "‚è≥ Validating Metadata...";

    const formData = new FormData();
    formData.append('photo', fileInput.files[0]);
    formData.append('city', "{{ weather.city }}");
    formData.append('choice', choice);

    try {
        const response = await fetch('/report', { method: 'POST', body: formData });
        const data = await response.json();
        
        // THIS IS THE PART THAT UPDATES YOUR SCREEN
        if(data.status === "success") {
            alert("‚úÖ " + data.message); // This will show the 1/5 confirms message
            log.innerText = data.message;
            log.style.color = "#10b981";
        } else {
            alert("‚ùå " + data.message); // This shows the "Photo too old" or "No EXIF" error
            log.innerText = data.message;
            log.style.color = "#f43f5e";
        }
    } catch (e) {
        console.error(e);
        alert("System Error: Check Terminal");
    }
}

    // --- BROADCAST LISTENER ---
    // Polls server for peer reports in this city
    setInterval(() => {
        const city = "{{ weather.city }}";
        fetch(`/get_broadcast/${city}`)
            .then(res => res.json())
            .then(data => {
                const toast = document.getElementById('peer-toast');
                if(data.active) {
                    toast.style.display = 'flex';
                    document.getElementById('peer-msg').innerText = 
                        `A peer reported ${data.type}. (${data.count}/5 Confirmed)`;
                } else {
                    toast.style.display = 'none';
                }
            });
    }, 10000);

    // --- STATUS CHECKER ---
    // Changes dashboard text to "Raining" once 5/5 reached
    setInterval(() => {
        const city = "{{ weather.city }}";
        fetch(`/check_status/${city}`)
            .then(res => res.json())
            .then(data => {
                const statusEl = document.getElementById('weather-status');
                if(data.status.includes("Verified")) {
                    statusEl.innerText = "üåßÔ∏è " + data.status;
                    statusEl.className = "pulse-red";
                }
            });
    }, 15000);

    function closeToast() { document.getElementById('peer-toast').style.display = 'none'; }
</script>
</body>
</html>